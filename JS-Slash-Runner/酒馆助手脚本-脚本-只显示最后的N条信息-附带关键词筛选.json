{
  "type": "script",
  "enabled": true,
  "name": "脚本-只显示最后的N条信息-附带关键词筛选",
  "id": "b4df384f-da54-4f52-896d-e54359c1f261",
  "content": "// ============ 只显示最后的N条信息+关键词筛选 ============\n// 初始化脚本变量默认值\ninsertVariables(\n  { joezhangynShowLastMessage: 10, joezhangynFilterKeywords: \"\", joezhangynHighlightDelay: 0.5 },\n  { type: \"script\" },\n);\n\nconst delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\n\n$(\"<style>\").text(\n  \".keyword-hl { background: #FFD700; color: #000; font-weight: bold; padding: 1px 4px; border-radius: 3px; }\",\n).appendTo(\"head\");\n\nasync function onlyShowLast() {\n  eventClearListener(onlyShowLast);\n\n  const lastId = getLastMessageId();\n  const variables = getVariables({ type: \"script\" });\n  const showLastMessage = variables.joezhangynShowLastMessage ?? 10;\n  const filterKeywords = variables.joezhangynFilterKeywords || \"\";\n\n  const startIndex =\n    showLastMessage === 0 || showLastMessage > lastId\n      ? 0\n      : lastId - showLastMessage + 1;\n  const endIndex = lastId + 1;\n\n  $(\"#chat\").children().remove();\n\n  let messagesToRender = [];\n\n  if (filterKeywords) {\n    for (let i = 0; i < SillyTavern.chat.length; i++) {\n      const message = SillyTavern.chat[i];\n      if (!message || !message.mes) continue;\n\n      if (matchesComplexPattern(message.mes, filterKeywords)) {\n        messagesToRender.push({ index: i, message, matched: true });\n      }\n    }\n  } else {\n    for (let i = startIndex; i < endIndex; i++) {\n      messagesToRender.push({ index: i, message: SillyTavern.chat[i] });\n    }\n  }\n\n  for (const item of messagesToRender) {\n    builtin.addOneMessage(item.message, { forceId: item.index });\n    eventEmit(\n      item.message.is_user\n        ? tavern_events.USER_MESSAGE_RENDERED\n        : tavern_events.CHARACTER_MESSAGE_RENDERED,\n      item.index,\n    );\n  }\n\n  if (filterKeywords) {\n    const highlightDelay = variables.joezhangynHighlightDelay ?? 0.5;\n    await delay(highlightDelay * 1000);\n    for (const item of messagesToRender) {\n      if (item.matched) {\n        highlightKeywordsInMessage(item.index, filterKeywords);\n      }\n    }\n  }\n\n  restoreListen();\n}\n\nfunction extractAllKeywords(pattern) {\n  return pattern\n    .replace(/\\(/g, \" \")\n    .replace(/\\)/g, \" \")\n    .split(/[&|]/)\n    .map((k) => k.trim())\n    .filter((k) => k.length > 0);\n}\n\nfunction highlightKeywordsInMessage(messageId, pattern) {\n  const keywords = extractAllKeywords(pattern);\n  if (!keywords.length) return;\n  keywords.sort((a, b) => b.length - a.length);\n\n  const $mes = retrieveDisplayedMessage(messageId);\n  if (!$mes.length) return;\n\n  const escaped = keywords.map((k) =>\n    k.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\"),\n  );\n  const keywordPattern = escaped.join(\"|\");\n  const regex = new RegExp(`(<[^>]+>)|(${keywordPattern})`, \"gi\");\n\n  $mes.html(\n    $mes.html().replace(regex, (match, tag, kw) => {\n      if (tag) return tag;\n      return `<span class=\"keyword-hl\">${kw}</span>`;\n    }),\n  );\n}\n\nfunction matchesComplexPattern(text, pattern) {\n  function evaluateExpression(expr, text) {\n    expr = expr.trim();\n    while (\n      expr.startsWith(\"(\") &&\n      expr.endsWith(\")\") &&\n      isBalancedParens(expr.slice(1, -1))\n    ) {\n      expr = expr.slice(1, -1).trim();\n    }\n    return evaluateTokens(tokenize(expr), text);\n  }\n\n  function isBalancedParens(str) {\n    let count = 0;\n    for (const char of str) {\n      if (char === \"(\") count++;\n      if (char === \")\") count--;\n      if (count < 0) return false;\n    }\n    return count === 0;\n  }\n\n  function tokenize(expr) {\n    const tokens = [];\n    let current = \"\";\n    let parenCount = 0;\n\n    for (const char of expr) {\n      if (char === \"(\") {\n        parenCount++;\n        current += char;\n      } else if (char === \")\") {\n        parenCount--;\n        current += char;\n      } else if (parenCount === 0 && (char === \"&\" || char === \"|\")) {\n        if (current.trim()) tokens.push(current.trim());\n        tokens.push(char);\n        current = \"\";\n      } else {\n        current += char;\n      }\n    }\n    if (current.trim()) tokens.push(current.trim());\n    return tokens;\n  }\n\n  function evaluateTokens(tokens, text) {\n    if (tokens.length === 1) {\n      const token = tokens[0];\n      if (token.startsWith(\"(\") && token.endsWith(\")\")) {\n        return evaluateExpression(token, text);\n      }\n      return new RegExp(token.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\"), \"i\").test(\n        text,\n      );\n    }\n\n    for (let i = 0; i < tokens.length; i++) {\n      if (tokens[i] === \"&\") {\n        return (\n          evaluateTokens(tokens.slice(0, i), text) &&\n          evaluateTokens(tokens.slice(i + 1), text)\n        );\n      }\n    }\n    for (let i = 0; i < tokens.length; i++) {\n      if (tokens[i] === \"|\") {\n        return (\n          evaluateTokens(tokens.slice(0, i), text) ||\n          evaluateTokens(tokens.slice(i + 1), text)\n        );\n      }\n    }\n    return false;\n  }\n\n  try {\n    return evaluateExpression(pattern, text);\n  } catch (e) {\n    console.error(\"Error parsing pattern:\", e);\n    return new RegExp(pattern.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\"), \"i\").test(\n      text,\n    );\n  }\n}\n\n// --- 按钮事件（弃用 eventOnButton → eventOn + getButtonEvent）---\n\neventOn(getButtonEvent(\"设置筛选关键词\"), async () => {\n  const current =\n    getVariables({ type: \"script\" }).joezhangynFilterKeywords || \"\";\n\n  const input = await SillyTavern.callGenericPopup(\n    `请输入筛选关键词:\n    - 使用 | 表示\"或\" (例如: A|B)\n    - 使用 & 表示\"并且\" (例如: A&B)\n    - 使用括号分组 (例如: (A|B)&(C|D))\n\n    当前关键词: ${current}`,\n    SillyTavern.POPUP_TYPE.INPUT,\n    current,\n  );\n\n  if (input === false) return;\n\n  insertOrAssignVariables(\n    { joezhangynFilterKeywords: input },\n    { type: \"script\" },\n  );\n  await onlyShowLast();\n  toastr.success(\n    input === \"\" ? \"已清除筛选关键词\" : `已设置筛选关键词: ${input}`,\n  );\n});\n\neventOn(getButtonEvent(\"修改显示条数\"), async () => {\n  const current =\n    getVariables({ type: \"script\" }).joezhangynShowLastMessage ?? 10;\n  const isShowAll = current === 0;\n\n  const input = await SillyTavern.callGenericPopup(\n    `请输入显示聊天条数(格式: 10)\\n\\n当前显示条数: ${isShowAll ? \"全部\" : current}`,\n    SillyTavern.POPUP_TYPE.INPUT,\n    isShowAll ? \"0\" : String(current),\n  );\n\n  if (input === false) return;\n  const num = Number(input);\n  if (!Number.isInteger(num) || num <= 0)\n    return void toastr.error(\"输入的非有效整数\");\n\n  insertOrAssignVariables(\n    { joezhangynShowLastMessage: num, joezhangynFilterKeywords: \"\" },\n    { type: \"script\" },\n  );\n  await onlyShowLast();\n  toastr.success(`已修改显示条数为: ${num}`);\n});\n\neventOn(getButtonEvent(\"显示全部条数\"), () => {\n  eventClearListener(onlyShowLast);\n  insertOrAssignVariables({ joezhangynShowLastMessage: 0, joezhangynFilterKeywords: \"\" }, { type: \"script\" });\n  builtin.reloadAndRenderChatWithoutEvents();\n  toastr.success(\"已切换为显示全部消息\");\n});\n\nfunction restoreListen() {\n  eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED, onlyShowLast);\n  eventOn(tavern_events.CHAT_CHANGED, onlyShowLast);\n}\n\nrestoreListen();",
  "info": "# 作者：JoeZhangYN\n## 版本日期：2026/1/31\n\n## 作用\n\n- 当消息渲染结束后自动根据指定的消息数量修改显示信息条数\n- 添加筛选聊天内容功能，可以根据关键词匹配哪怕不在指定范围内的聊天记录\n  - 使用 `|` 表示\"或\"（例如：`A|B` 匹配包含 A 或 B 的消息）\n  - 使用 `&` 表示\"并且\"（例如：`A&B` 匹配同时包含 A 和 B 的消息）\n  - 使用括号分组（例如：`(A|B)&(C|D)` 匹配包含 A 或 B 并且包含 C 或 D 的消息）\n- 筛选到的关键词高亮显示，渲染完成后通过 DOM 操作添加醒目样式\n\n## 变量说明\n\n| 变量名 | 类型 | 默认值 | 说明 |\n|--------|------|--------|------|\n| `joezhangynShowLastMessage` | number | 10 | 显示多少条记录，0 为全部 |\n| `joezhangynFilterKeywords` | string | `\"\"` | 关键词匹配表达式，支持 `\\|` `&` `()` 组合 |\n| `joezhangynHighlightDelay` | number | 0.5 | 等待渲染完成后高亮的延时（单位秒，支持小数），高亮不生效可调大该值 |\n\n## 按钮说明\n\n| 按钮名 | 功能 |\n|--------|------|\n| 设置筛选关键词 | 弹窗输入关键词表达式，设置后立即筛选并高亮 |\n| 修改显示条数 | 弹窗输入显示条数，同时清除筛选关键词 |\n| 显示全部条数 | 切换为显示全部消息，清除筛选关键词 |\n\n## 事件监听\n\n| 事件 | 触发动作 |\n|------|----------|\n| `CHARACTER_MESSAGE_RENDERED` | 重新渲染筛选后的消息 |\n| `CHAT_CHANGED` | 重新渲染筛选后的消息 |\n\n## 更新\n\n- 25/5/12 开启脚本后自动监听，默认显示最后 10 条记录\n- 25/5/13 新增特殊化处理匹配的关键词，让其更加明显\n- 26/1/31 适配新 API，变更变量为脚本变量，修复高亮显示\n  - 变量迁移至 `{ type: \"script\" }` 作用域，添加 `joezhangyn` 前缀\n  - 使用 `retrieveDisplayedMessage` 跨 iframe 操作 DOM 实现关键词高亮\n  - 新增 `joezhangynHighlightDelay` 变量控制高亮延时\n  - 修改/显示全部按钮同时清除筛选关键词\n  - 按钮事件迁移至 `eventOn` + `getButtonEvent` 模式",
  "button": {
    "enabled": true,
    "buttons": [
      {
        "name": "设置筛选关键词",
        "visible": true
      },
      {
        "name": "修改显示条数",
        "visible": true
      },
      {
        "name": "显示全部条数",
        "visible": true
      }
    ]
  },
  "data": {}
}